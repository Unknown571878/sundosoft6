<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기본 지도</title>
    <!-- Leaflet CSS 파일 포함 -->
    <link rel="stylesheet" href="/css/mapOptionLayer.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script type="text/javascript"
            src="https://map.vworld.kr/js/vworldMapInit.js.do?version=2.0&apiKey=8A69FB7A-6E07-3B76-B2F2-1D1FEF0E5781"></script>
    <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
    <script src="https://map.vworld.kr/jquery/ol3/jquery-1.11.3.min.js" async></script>
    <style>
        /* 지도 크기 설정 */
        #map {
            height: 950px; /* 지도 높이 */
        }
    </style>
</head>
<body>
<!-- 지도 표시할 요소 -->
<div class="ft">
    <!--  <input type="hidden" th:value="${id}" id='hidden-map'> !-->
    <div class="main-map">
        <div class="map" id="map"><!--th:id="${id}" !-->
            <th:block th:replace="layout/mapLayout :: mapLayout"></th:block>
        </div>
    </div>
</div>

<!-- Leaflet JS 파일 포함 -->
<script th:src="${scriptPath}" th:text="${scriptPath}"></script>

<!-- Leaflet JS 파일 포함 -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    const vworldKey = '8A69FB7A-6E07-3B76-B2F2-1D1FEF0E5781';

    document.addEventListener("DOMContentLoaded", function () {
        // 모든 상위 메뉴 항목을 선택
        const menuItems = document.querySelectorAll(".submenu-item");

        menuItems.forEach((menuItem) => {
            // 다음 형제 요소가 <ul>인지 확인
            const submenu = menuItem.nextElementSibling;

            if (submenu && submenu.tagName === "UL") {
                // 하위 메뉴의 <li> 개수 카운트
                const itemCount = submenu.querySelectorAll("li").length;

                // 카운트 뱃지 생성
                const badge = document.createElement("span");
                badge.className = "menu-badge";
                badge.textContent = itemCount;

                // 메뉴 항목에 뱃지를 추가
                menuItem.appendChild(badge);
            }
        });
    });

    const draggableList = document.getElementById('draggable-checkbox-list'); // 드래그 가능한 리스트 요소 가져오기
    let draggedItem = null; // 드래그 중인 항목
    let placeholder = null; // 플레이스홀더 요소
    let layer_list = [];
    const categoryButton = document.querySelectorAll('#category-button button');
    const submenuList = document.querySelectorAll('#submenu-list li');
    const submenuList2 = document.querySelectorAll('#submenu-list2 li');

    // 각 버튼에 클릭 이벤트 추가
    categoryButton.forEach((button) => {
        button.addEventListener('click', () => {
            const category = button.id.replace('category-', '');
            if (category === 'all') {
                // "전체" 버튼 클릭 시 모든 li 표시
                submenuList.forEach((li) => li.classList.remove('hidden'));
                submenuList2.forEach((li) => li.classList.remove('hidden'));
            } else {
                // 모든 li 숨기기
                submenuList.forEach((li) => {
                    if (li.id.includes(category)) {
                        li.classList.remove('hidden'); // 선택된 카테고리는 표시
                    } else {
                        li.classList.add('hidden'); // 나머지는 숨기기
                    }
                });
                submenuList2.forEach((li) => {
                    if (li.id.includes(category)) {
                        li.classList.remove('hidden'); // 선택된 카테고리는 표시
                    } else {
                        li.classList.add('hidden'); // 나머지는 숨기기
                    }
                });
            }
        });
    });
    // 드래그 앤 드롭 이벤트 처리
    draggableList.addEventListener('dragstart', (e) => {
        if (e.target.tagName === 'LI') { // 드래그가 LI 요소에서 시작될 때만 실행
            draggedItem = e.target; // 드래그 중인 항목 저장
            draggedItem.classList.add('dragging'); // 드래그 중인 항목에 스타일 추가
            placeholder = document.createElement('li'); // 플레이스홀더 생성
            placeholder.className = 'placeholder'; // 플레이스홀더 스타일 클래스 추가
            e.target.parentNode.insertBefore(placeholder, e.target.nextSibling); // 플레이스홀더를 드래그 항목 아래에 추가
        }
    });
    draggableList.addEventListener('dragover', (e) => {
        e.preventDefault(); // 기본 동작 방지
        const draggingOverItem = e.target.closest('li'); // 드래그 중인 항목 탐지
        if (draggingOverItem && draggingOverItem !== placeholder && draggingOverItem !== draggedItem) { // 유효한 항목일 경우
            const bounding = draggingOverItem.getBoundingClientRect(); // 항목의 위치 정보 가져오기
            const offset = e.clientY - bounding.top; // 마우스 위치 계산
            if (offset > bounding.height / 2) { // 마우스가 항목의 하단에 위치한 경우
                draggingOverItem.after(placeholder); // 플레이스홀더를 항목 뒤로 이동
            } else { // 상단에 위치한 경우
                draggingOverItem.before(placeholder); // 플레이스홀더를 항목 앞으로 이동
            }
        }
    });

    const layer_invisible = document.getElementById('layer-invisible');
    const check_layer = document.getElementById('check-layer');
    const layer_cancel = document.getElementById('layer-cancel');

    layer_cancel.addEventListener('click', ()=>{
        if (check_layer.style.display === 'block' || check_layer.style.display === '') {
            check_layer.style.display = 'none';
        }
    });
    layer_invisible.addEventListener('click', () => {
        if (check_layer.style.display === 'block' || check_layer.style.display === '') {
            check_layer.style.display = 'none'; // 안 보이게 설정
        }
        else if (check_layer.style.display === 'none') {
            check_layer.style.display = 'block'; // 보이게 설정

        }
    });
    const layer_names = [
        { name: '광주 동', id: 'gwangju_dong' },
        { name: '광주 구', id: 'gwangju_gu' },
        { name: '초등학생', id: 'gwangju_population_10c' },
        { name: '중학생', id: 'gwangju_population_10j' },
        { name: '고등학생', id: 'gwangju_population_10g' },
        { name: '20대', id: 'gwangju_population_20y' },
        { name: '30대', id: 'gwangju_population_30y' },
        { name: '40대', id: 'gwangju_population_40y' },
        { name: '50대', id: 'gwangju_population_50y' },
        { name: '60대', id: 'gwangju_population_60y' },
        { name: '70대', id: 'gwangju_population_70y' },
        { name: '80대', id: 'gwangju_population_80y' },
        { name: '90대', id: 'gwangju_population_90y' },
        { name: '모든 연령대', id: 'gwangju_population_all' },
        { name: '경지정리답', id: 'gwangju_toji_use_1110' },
        { name: '미경지정리답', id: 'gwangju_toji_use_1120' },
        { name: '보통,특수작물', id: 'gwangju_toji_use_1210' },
        { name: '과수원 기타', id: 'gwangju_toji_use_1220' },
        { name: '자연초지', id: 'gwangju_toji_use_2110' },
        { name: '인공초지', id: 'gwangju_toji_use_2120' },
        { name: '침엽수림', id: 'gwangju_toji_use_2210' },
        { name: '활엽수림', id: 'gwangju_toji_use_2220' },
        { name: '혼합수림', id: 'gwangju_toji_use_2230' },
        { name: '골프장', id: 'gwangju_toji_use_2310' },
        { name: '공원묘지', id: 'gwangju_toji_use_2320' },
        { name: '유원지', id: 'gwangju_toji_use_2330' },
        { name: '일반주택지', id: 'gwangju_toji_use_3110' },
        { name: '고층주택지', id: 'gwangju_toji_use_3120' },
        { name: '상업,업무지', id: 'gwangju_toji_use_3130' },
        { name: '나대지 및 인공녹지', id: 'gwangju_toji_use_3140' },
        { name: '도로', id: 'gwangju_toji_use_3210' },
        { name: '철로 및 주변지역', id: 'gwangju_toji_use_3220' },
        { name: '공항', id: 'gwangju_toji_use_3230' },
        { name: '공업시설', id: 'gwangju_toji_use_3310' },
        { name: '공업나지, 기타', id: 'gwangju_toji_use_3320' },
        { name: '발전시설', id: 'gwangju_toji_use_3410' },
        { name: '처리장', id: 'gwangju_toji_use_3420' },
        { name: '교육, 군사시설', id: 'gwangju_toji_use_3430' },
        { name: '공공용지', id: 'gwangju_toji_use_3440' },
        { name: '양어장, 양식장', id: 'gwangju_toji_use_3510' },
        { name: '채광지역', id: 'gwangju_toji_use_3520' },
        { name: '매립지', id: 'gwangju_toji_use_3530' },
        { name: '가축사육시설', id: 'gwangju_toji_use_3550' },
        { name: '하천', id: 'gwangju_toji_use_4210' },
        { name: '호, 소', id: 'gwangju_toji_use_4310' },
        { name: '댐', id: 'gwangju_toji_use_4320' },
        { name: '일본인, 창씨명등', id: 'gwangju_toji_owner_00' },
        { name: '개인', id: 'gwangju_toji_owner_01' },
        { name: '국유지', id: 'gwangju_toji_owner_02' },
        { name: '외국인, 외국공공기관', id: 'gwangju_toji_owner_03' },
        { name: '시, 도유지', id: 'gwangju_toji_owner_04' },
        { name: '군유지', id: 'gwangju_toji_owner_05' },
        { name: '법인', id: 'gwangju_toji_owner_06' },
        { name: '종증', id: 'gwangju_toji_owner_07' },
        { name: '종교단체', id: 'gwangju_toji_owner_08' },
        { name: '기타', id: 'gwangju_toji_owner_09' },
        { name: '도서관', id: 'gwangju_library' },
        { name: '민원발급기', id: 'gwangju_civil_service_machines' },
        { name: '천안 구', id: 'cheonan_si'},
        { name: '도서관', id: 'cheonan_library_20240610'}
    ];
    // 레이어의 인덱스와 체크박스의 ID를 배열로 정의
    const layers = [
        { id: 'gwangju_dong', layerIndex: 1 },
        { id: 'gwangju_gu', layerIndex: 2 },
        { id: 'gwangju_population_10c', layerIndex: 3 },
        { id: 'gwangju_population_10j', layerIndex: 4 },
        { id: 'gwangju_population_10g', layerIndex: 5 },
        { id: 'gwangju_population_20y', layerIndex: 6 },
        { id: 'gwangju_population_30y', layerIndex: 7 },
        { id: 'gwangju_population_40y', layerIndex: 8 },
        { id: 'gwangju_population_50y', layerIndex: 9 },
        { id: 'gwangju_population_60y', layerIndex: 10 },
        { id: 'gwangju_population_70y', layerIndex: 11 },
        { id: 'gwangju_population_80y', layerIndex: 12 },
        { id: 'gwangju_population_90y', layerIndex: 13 },
        { id: 'gwangju_population_all', layerIndex: 14 },
        { id: 'gwangju_toji_use_1110', layerIndex: 15 },
        { id: 'gwangju_toji_use_1120', layerIndex: 16 },
        { id: 'gwangju_toji_use_1210', layerIndex: 17 },
        { id: 'gwangju_toji_use_1220', layerIndex: 18 },
        { id: 'gwangju_toji_use_2110', layerIndex: 19 },
        { id: 'gwangju_toji_use_2120', layerIndex: 20 },
        { id: 'gwangju_toji_use_2210', layerIndex: 21 },
        { id: 'gwangju_toji_use_2220', layerIndex: 22 },
        { id: 'gwangju_toji_use_2230', layerIndex: 23 },
        { id: 'gwangju_toji_use_2310', layerIndex: 24 },
        { id: 'gwangju_toji_use_2320', layerIndex: 25 },
        { id: 'gwangju_toji_use_2330', layerIndex: 26 },
        { id: 'gwangju_toji_use_3110', layerIndex: 27 },
        { id: 'gwangju_toji_use_3120', layerIndex: 28 },
        { id: 'gwangju_toji_use_3130', layerIndex: 29 },
        { id: 'gwangju_toji_use_3140', layerIndex: 30 },
        { id: 'gwangju_toji_use_3210', layerIndex: 31 },
        { id: 'gwangju_toji_use_3220', layerIndex: 32 },
        { id: 'gwangju_toji_use_3230', layerIndex: 33 },
        { id: 'gwangju_toji_use_3310', layerIndex: 34 },
        { id: 'gwangju_toji_use_3320', layerIndex: 35 },
        { id: 'gwangju_toji_use_3410', layerIndex: 36 },
        { id: 'gwangju_toji_use_3420', layerIndex: 37 },
        { id: 'gwangju_toji_use_3430', layerIndex: 38 },
        { id: 'gwangju_toji_use_3440', layerIndex: 39 },
        { id: 'gwangju_toji_use_3510', layerIndex: 40 },
        { id: 'gwangju_toji_use_3520', layerIndex: 41 },
        { id: 'gwangju_toji_use_3530', layerIndex: 42 },
        { id: 'gwangju_toji_use_3550', layerIndex: 43 },
        { id: 'gwangju_toji_use_4210', layerIndex: 44 },
        { id: 'gwangju_toji_use_4310', layerIndex: 45 },
        { id: 'gwangju_toji_use_4320', layerIndex: 46 },
        { id: 'gwangju_toji_owner_00', layerIndex: 47 },
        { id: 'gwangju_toji_owner_01', layerIndex: 48 },
        { id: 'gwangju_toji_owner_02', layerIndex: 49 },
        { id: 'gwangju_toji_owner_03', layerIndex: 50 },
        { id: 'gwangju_toji_owner_04', layerIndex: 51 },
        { id: 'gwangju_toji_owner_05', layerIndex: 52 },
        { id: 'gwangju_toji_owner_06', layerIndex: 53 },
        { id: 'gwangju_toji_owner_07', layerIndex: 54 },
        { id: 'gwangju_toji_owner_08', layerIndex: 55 },
        { id: 'gwangju_toji_owner_09', layerIndex: 56 },
        { id: 'gwangju_library', layerIndex: 57 },
        { id: 'gwangju_civil_service_machines', layerIndex: 58 },
        { id: 'cheonan_si', layerIndex: 59},
        { id: 'cheonan_library_20240610', layerIndex: 60}
    ];

    const regions = {
        gwangju: { center: [35.1595, 126.8526], zoom: 11 },  // 광주의 중심 좌표 및 줌 레벨
        cheonan: { center: [36.8154, 127.1523], zoom: 12 }   // 천안의 중심 좌표 및 줌 레벨
    };
    // 현재 지역 상태 저장
    let currentRegion = 'gwangju'; // 초기값: 광주
    let activeLayers = []; // 현재 활성화된 레이어들을 저장할 배열


    // 초기화 상태 저장
    const initialCheckboxState = {};
    layers.forEach(layerInfo => {
        initialCheckboxState[layerInfo.id] = false; // 모든 체크박스 기본값은 false
    });
    const initialDraggableListHTML = ''; // 초기 우선순위 리스트는 비어 있음

    // 모든 활성화된 레이어와 우선순위 리스트 초기화 및 복원
    function resetToInitialState() {
        // 지도에서 활성화된 레이어 제거
        activeLayers.forEach(layer => {
            map.removeLayer(layer);
        });
        activeLayers = []; // 활성화된 레이어 리스트 초기화

        // 체크박스 상태 초기화
        layers.forEach(layerInfo => {
            const checkbox = document.getElementById(layerInfo.id); // 왼쪽 체크박스
            const searchCheckbox = document.getElementById('search-' + layerInfo.id); // 검색 체크박스
            const initialState = initialCheckboxState[layerInfo.id];
            if (checkbox) checkbox.checked = initialState; // 초기 상태로 복원
            if (searchCheckbox) searchCheckbox.checked = initialState; // 초기 상태로 복원
        });

        // 우선순위 리스트 초기화
        const draggableList = document.getElementById('draggable-checkbox-list');
        draggableList.innerHTML = initialDraggableListHTML; // 초기 HTML로 복원
    }

    // 광주 메뉴 보이기
    document.getElementById('submenu-list').style.display = 'block';
    // 천안 메뉴 숨기기
    document.getElementById('submenu-list2').style.display = 'none';

    // 광주 버튼 클릭 시
    document.getElementById('btn-gwangju').addEventListener('click', function() {
        // 광주 중심으로 이동하고 줌 레벨 설정
        map.setView(regions.gwangju.center, regions.gwangju.zoom);
        currentRegion = 'gwangju'; // 현재 지역 설정
        document.getElementById('layer-search').value = ''; // 검색창 초기화
        resetToInitialState()
        filterList(); // 검색 결과 갱신
        // 광주 메뉴 보이기
        document.getElementById('submenu-list').style.display = 'block';

        // 천안 메뉴 숨기기
        document.getElementById('submenu-list2').style.display = 'none';
    });
    // 천안 버튼 클릭 시
    document.getElementById('btn-cheonan').addEventListener('click', function() {
        // 천안 중심으로 이동하고 줌 레벨 설정
        map.setView(regions.cheonan.center, regions.cheonan.zoom);
        currentRegion = 'cheonan'; // 현재 지역 설정
        document.getElementById('layer-search').value = ''; // 검색창 초기화
        resetToInitialState();
        filterList(); // 검색 결과 갱신
        // 천안 메뉴 보이기
        document.getElementById('submenu-list2').style.display = 'block';

        // 광주 메뉴 숨기기
        document.getElementById('submenu-list').style.display = 'none';
    });
    // 지도 생성
    var map = L.map('map').setView([35.1595, 126.8526], 13); // 위도, 경도, 줌 레벨 설정

    var vworldLayer = L.tileLayer('https://xdworld.vworld.kr/2d/Base/service/{z}/{x}/{y}.png', {
        "minZoom": 6,
        "maxZoom": 22,
        "maxNativeZoom": 19,
        "attribution": '&copy; <a href="http://www.vworld.kr/">vworld</a> contributors'
    });

    var hybrid = L.tileLayer(`http://api.vworld.kr/req/wmts/1.0.0/${vworldKey}/Hybrid/{z}/{y}/{x}.png`, {
        attribution: '&copy; VWorld',
        maxZoom: 15,
        minZoom: 1,
        zIndex: 10  // zIndex 설정
    });
    var satellite = L.tileLayer(`http://api.vworld.kr/req/wmts/1.1.1/${vworldKey}/Satellite/{z}/{y}/{x}.jpeg`, {
        attribution: '&copy; VWorld',
        maxZoom: 15,
        minZoom: 1,
        zIndex: 5  // zIndex 설정
    });
    vworldLayer.addTo(map);

    // 일반지도, 위성지도 띄우는거 선택
    var general_map = document.getElementById('general_map');
    var satellite_map = document.getElementById('satellite_map');
    var satellite_true = true;
    general_map.addEventListener('click', function (){
        if(satellite){
            hybrid.remove();
            satellite.remove();
        }
        satellite_true = !satellite_true;
    })
    satellite_map.addEventListener('click', function (){
        // 상태에 따라 다른 작업 실행
        if (satellite_true) {
            console.log('True: 위성지도를 활성화');
            hybrid.addTo(map);
            satellite.addTo(map);
        }
        // 상태를 변경 (true <-> false)
        satellite_true = !satellite_true;
    })

    // 지도 컨테이너와 자식 요소들 가져오기
    const mapContainer = document.getElementById('map');
    const childElements = mapContainer.querySelectorAll('*'); // #map 아래의 모든 자식 요소 선택
    // 모달과 닫기 버튼 선택
    const modal = document.getElementById('modal');
    const modalClose = document.getElementById('modal-close');
    const modalContent = document.getElementById('modal-content');

    document.getElementById('modal').addEventListener('wheel', (e) => {
        e.stopPropagation();
    });

    // 각 자식 요소에 마우스 이벤트 추가
    childElements.forEach(element => {
        // 마우스가 자식 요소 위에 올라가면 지도 상호작용 비활성화
        element.addEventListener('mouseover', () => {
            map.dragging.disable();
            map.touchZoom.disable();
            map.doubleClickZoom.disable();
            map.scrollWheelZoom.disable();
            map.off('click')
        });

        // 마우스가 자식 요소에서 벗어나면 지도 상호작용 활성화
        element.addEventListener('mouseout', () => {
            map.dragging.enable();
            map.touchZoom.enable();
            map.doubleClickZoom.enable();
            map.scrollWheelZoom.enable();
            // 지도 클릭 이벤트
            map.on('click', function (e) {
                const { lat, lng } = e.latlng; // Leaflet 기준 좌표 가져오기
                modalContent.innerHTML = `<p>클릭한 위치의 좌표:</p><p>위도: ${lat.toFixed(5)}</p><p>경도: ${lng.toFixed(5)}</p>`;
                modal.style.display = 'block';
            });
        });
    });
    // 모달 닫기 이벤트
    modalClose.addEventListener('click', function (e) {
        modal.style.display = 'none';
    });

    // WMS 레이어 추가 함수
    function createWmsLayer(layerId, layerIndex) {
        const layer = L.tileLayer.wms('http://localhost:8080/geoserver/ne/wms', {
            layers: `ne:${layerId}`,  // 'ne:' 접두사 추가
            format: 'image/png',
            transparent: true,
            attribution: '&copy; GeoServer Contributors',
            zIndex: layerIndex  // 숫자로 zIndex 설정
        });
        layer.options.id = `ne:${layerId}`;
        return layer;
    }

    // 전체화면 버튼 구현
    const fullscreenButton = document.getElementById('fullscreenButton');
    fullscreenButton.addEventListener('click', () => {
        if (mapContainer.requestFullscreen) {
            mapContainer.requestFullscreen(); // 표준 API
        } else if (mapContainer.webkitRequestFullscreen) {
            mapContainer.webkitRequestFullscreen(); // Safari
        } else if (mapContainer.msRequestFullscreen) {
            mapContainer.msRequestFullscreen(); // IE/Edge
        } else {
            alert('전체화면 API가 지원되지 않는 브라우저입니다.');
        }
    });

    // 입지분석 레이어 on/off 버튼
    const analysisBtn = document.getElementById('analysisBtn');
    const analysisLayer = document.getElementById('analysis-layer');
    const analysisCancel = document.getElementById('analysis-cancel');
    analysisCancel.addEventListener('click', ()=>{
        if (analysisLayer.style.display === 'flex' || analysisLayer.style.display === '') {
            analysisLayer.style.display = 'none';
        }
    });
    analysisBtn.addEventListener('click', () => {
        if (analysisLayer.style.display === 'flex' || analysisLayer.style.display === '') {
            analysisLayer.style.display = 'none'; // 안 보이게 설정
        }
        else if (analysisLayer.style.display === 'none') {
            analysisLayer.style.display = 'flex'; // 보이게 설정
        }
    });

    document.addEventListener("DOMContentLoaded", () => {
        const tabs = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");

        // 탭 전환 기능
        tabs.forEach((tab) => {
            tab.addEventListener("click", () => {
                // 모든 탭 비활성화
                tabs.forEach((t) => t.classList.remove("active"));
                tabContents.forEach((content) => (content.style.display = "none"));

                // 선택한 탭 활성화
                tab.classList.add("active");
                const target = tab.getAttribute("data-tab");
                document.getElementById(target).style.display = "block";
            });
        });
    });

    // 레이어 배열을 돌면서 WMS 레이어 생성
    const layerInstances = {};  // 레이어 인스턴스를 저장할 객체
    console.log(layerInstances);

    // 레이어 추가 삭제
    layers.forEach(function(layerInfo) {
        const wmsLayer = createWmsLayer(layerInfo.id, layerInfo.layerIndex*10);
        layerInstances[layerInfo.id] = wmsLayer;  // WMS 레이어를 객체에 저장

        // 체크박스에 이벤트 리스너 추가
        var checkbox = document.getElementById(layerInfo.id);  // 왼쪽 체크박스를 찾음
        var rightCheckbox = document.getElementById('search-' + layerInfo.id);  // 오른쪽 체크박스 찾기

        checkbox.addEventListener('change', function(event) {
            if (event.target.checked) {
                map.addLayer(wmsLayer);  // Leaflet에서 레이어를 추가하는 방법
                activeLayers.push(wmsLayer);
                // 레이어 우선순위에 추가
                const ul = document.getElementById("draggable-checkbox-list");
                const newLi = document.createElement("li");
                newLi.setAttribute("draggable", "true");
                newLi.setAttribute("id", layerInfo.id + '-layer');

                const newBtn = document.createElement("button");
                newBtn.setAttribute("id", layerInfo.id);
                newBtn.setAttribute("class", "cancel-layer");

                const newDragImg = document.createElement("img");
                newDragImg.setAttribute("src", "/images/icons8-메뉴.svg");
                newDragImg.setAttribute("style", "width: 20px; height: 20px");
                newDragImg.setAttribute("draggable", "false");

                const newLabel = document.createElement("label");
                newLabel.setAttribute("for", layerInfo.id + '-label');

                var findName = layer_names.find(layer => layer.id === layerInfo.id);
                newLabel.textContent = findName.name;

                const newCancelImg = document.createElement("img");
                newCancelImg.setAttribute("src", "/images/icons8-취소.svg");
                newCancelImg.setAttribute("style", "width: 20px; height: 20px");
                newCancelImg.setAttribute("draggable", "false");

                newBtn.appendChild(newCancelImg);
                newLi.appendChild(newDragImg);
                newLi.appendChild(newLabel);
                newLi.appendChild(newBtn);
                ul.appendChild(newLi);
                // cancel 버튼 클릭 이벤트 추가
                newBtn.addEventListener('click', function() {
                    var searchBox = document.getElementById('search-' + layerInfo.id);
                    // li 태그 삭제
                    newLi.remove();

                    // 체크박스 해제
                    checkbox.checked = false;
                    if (searchBox !== null) {
                        searchBox.checked = false;
                    }

                    // WMS 레이어 제거
                    map.removeLayer(wmsLayer);  // Leaflet에서 지도에서 제거
                    activeLayers = activeLayers.filter(layer => layer !== wmsLayer);
                });
            } else {
                const div_layer = document.querySelector(`#${layerInfo.id}-layer`);
                if (div_layer)
                    div_layer.remove();
                map.removeLayer(wmsLayer);  // Leaflet에서 레이어를 제거하는 방법
                activeLayers = activeLayers.filter(layer => layer !== wmsLayer);
            }
            // 오른쪽 체크박스 상태 동기화
            if (rightCheckbox) {
                rightCheckbox.checked = checkbox.checked;
            }




        });

        // 오른쪽 체크박스의 상태가 바뀌었을 때 왼쪽 체크박스도 변경
        if (rightCheckbox) {
            rightCheckbox.addEventListener('change', function() {
                if (rightCheckbox.checked) {
                    checkbox.checked = true;  // 왼쪽 체크박스도 체크
                    map.addLayer(wmsLayer);   // Leaflet에서 레이어를 추가
                } else {
                    checkbox.checked = false; // 왼쪽 체크박스 해제
                    map.removeLayer(wmsLayer); // Leaflet에서 레이어를 제거
                }
            });
        }

        // 초기 상태를 체크박스에 맞춰 설정
        if (checkbox.checked) {
            map.addLayer(wmsLayer);  // 초기 상태가 체크되었으면 지도에 추가
            if (rightCheckbox) {
                rightCheckbox.checked = true;  // 오른쪽 체크박스도 체크
            }
        }
    });
    // 레이어 우선 순위
    draggableList.addEventListener('dragend', () => {
        if (draggedItem) {  // 드래그 항목이 있을 경우
            draggedItem.classList.remove('dragging');  // 드래그 중 스타일 제거
            if (placeholder) {  // 플레이스홀더가 존재할 경우
                placeholder.parentNode.replaceChild(draggedItem, placeholder);  // 플레이스홀더를 드래그 항목으로 교체
                placeholder = null;  // 플레이스홀더 제거
            }
            draggedItem = null;  // 드래그 항목 초기화

            // 모든 li 요소를 배열로 가져오기
            const items = Array.from(draggableList.querySelectorAll('li'));
            layer_list = [];  // 배열 초기화 (이전에 저장된 값들을 제거)

            items.forEach((item, index) => {
                const label = item.querySelector('label');  // li 안의 label 요소 선택
                const labelText = label.textContent.trim();  // label 텍스트 가져오기
                const id = item.id.slice(0, -6);  // ID에서 _layer 부분 제거
                layer_list.push({ index: 1000 - (index * 50), id: "ne:" + id, labelText: labelText });
            });

            // 현재 맵에 존재하는 레이어를 순회하면서 id가 일치하는 레이어의 zIndex를 수정
            map.eachLayer(function (layer) {
                const layerId = layer.options.id;  // Leaflet에서 레이어의 id는 options에 저장됩니다.
                console.log(`Layer ID: ${layerId}`);  // 레이어 ID 확인

                const matchingLayer = layer_list.find(item => item.id === layerId);

                if (matchingLayer) {
                    // 해당 레이어가 layer_list에 존재하면 zIndex 값을 수정
                    console.log(`Layer ${layerId} zIndex updated to ${matchingLayer.index}`);
                    layer.setZIndex(matchingLayer.index);  // zIndex 설정
                } else {
                    console.log(`No matching layer found for ${layerId}`);
                }
            });

            console.log('layer_list:', layer_list);  // 최종적으로 저장된 배열 출력
        }
    });

    // 메뉴 열고 닫기 토글 기능
    function toggleMenu() {
        const menu = document.getElementById('menu');
        const menuButton = document.getElementById('menu-button');
        menu.classList.toggle('hidden');
        menuButton.classList.toggle('hidden');
    }

    // 서브메뉴 열고 닫기 토글 기능
    function toggleSubmenu(event, element) {
        event.preventDefault();
        const listItem = element.parentElement;
        const submenu = listItem.querySelector('.submenu');
        if (submenu) {
            submenu.classList.toggle('active');
        }
    }
    // 검색 입력 필드에 이벤트 리스너 추가
    document.getElementById('layer-search').addEventListener('input', filterList);

    function filterList() {
        const keyword = document.getElementById('layer-search').value.trim().toLowerCase();
        const searchList = document.getElementById('search-list');

        if (keyword === '') {
            searchList.style.display = 'none'; // 검색어가 없으면 숨기기
            searchList.innerHTML = ''; // 리스트 초기화
            return;
        }

        searchList.style.display = 'block'; // 검색어가 있으면 표시
        searchList.innerHTML = ''; // 기존 검색 결과 초기화

        // 입력된 키워드와 일치하는 항목 필터링
        const filteredItems = layer_names.filter(item =>
            item.name.toLowerCase().includes(keyword)&&
            item.id.startsWith(currentRegion)); // 현재 지역에 해당하는 ID만 포함);););

        filteredItems.forEach(item => {
            const listItem = document.createElement('li');
            listItem.classList.add('check-item'); // li에 클래스 추가

            const span = document.createElement('span');
            span.classList.add('submenu-item');
            span.textContent = item.name; // 레이어 이름 표시

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = item.id;
            checkbox.id = 'search-' + item.id;
            checkbox.checked = document.getElementById(item.id)?.checked || false; // 기존 체크박스 상태 동기화

            listItem.appendChild(span);
            listItem.appendChild(checkbox);
            searchList.appendChild(listItem);

            // 기존 체크박스와 동기화
            checkbox.addEventListener('change', function (event) {
                const originalCheckbox = document.getElementById(item.id);
                originalCheckbox.checked = event.target.checked; // 원래 체크박스 상태 동기화

                // 기존 이벤트 트리거
                originalCheckbox.dispatchEvent(new Event('change'));
            });
        });
    }
</script>
</body>
</html>
